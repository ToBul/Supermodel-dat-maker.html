<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Supermodel dat maker</title>
	<style>
		.hidden {
			display: none;
		}
		.show {
			display: inline;
		}
		.div {
			margin-left: 20px;
		}
	</style>
</head>
<body>
	<div class="div">
		<p style="font-size:260%">Supermodel dat maker</p>
		<pre id="output"></pre>
		<button id="dlbutton" class="hidden">Download Supermodel.dat</button>
	</div>
	<script>
		/////////////////////////// Element stuff ///////////////////////////

		const outputElement = document.getElementById('output');
		const log = (message) => {
			outputElement.textContent += message + '\n';
			console.log(message);
		}

		const dlBtnElement = document.getElementById("dlbutton");
			dlBtnElement.addEventListener("click", function () {
				generateOutput();
		});

		function toggleHiddenElement(id) {
			const showState = document.getElementById(id);
				if (showState.className == "hidden") {
					showState.className = "show";
				} else {
					showState.className = "hidden";
				}
		}

		/////////////////////////// Data stuff ///////////////////////////

		let datContent = "";

		async function buildDat() {
			const romsByCrc = await fetchMameFilesFromUrl();
			if (Object.keys(romsByCrc).length) {
				log(`${Object.keys(romsByCrc).length} Unique CRCs found\n`);
			} else {
				alert(`Error creating CRC info\nRefresh the page to try again`);
				return;
			}

			await parseGamesxml(romsByCrc);
				if (!datContent) {
					alert(`Error creating dat output\nRefresh the page to try again`)
					return;
				}

			log(`Operation finished\n`);
			toggleHiddenElement(`dlbutton`);
		}

		async function fetchMameFilesFromUrl(content) {
			const romsByCrc = {};
			let RomsFound = 0;
			const MameUrl = "https://raw.githubusercontent.com/mamedev/mame/master/src/mame/sega/";
			const mameDrivers = ["model3.cpp", "segabill.cpp", "model2.cpp"];
			const regex = /"(.*?)",\s*0x[0-9a-fA-F]+\s*,\s*0x([0-9a-fA-F]+)\s*,\s*CRC\(([0-9a-fA-F]{8})\)\s*SHA1\(([0-9a-fA-F]{40})\)/;
			let len = mameDrivers.length;
			for (let i = 0; i < len; i++) {
				log(`Fetching content from: ${MameUrl + mameDrivers[i]}`);
				const content = await getFileContent(MameUrl, mameDrivers[i]);
				if (!content) {
					alert(`Error fetching ${mameDrivers[i]}\nRefresh the page to try again`);
					return;
				}
				else {
					log(`Finding CRCs and collecting SHA-1 and size info from ${mameDrivers[i]}\n`);
					const lines = content.split(/\r?\n/);
					for (const line of lines) {
						if (line.trimStart().substring(0, 8) == "ROM_LOAD") {
							const match = line.match(regex);
							if (match) {
								RomsFound += 1;
								const filename = match[1].toLocaleLowerCase();
								const romNameArray = [filename];
								const size = parseInt(match[2], 16);
								const crc = match[3].toLocaleLowerCase();
								const sha1 = match[4].toLocaleLowerCase();
								const foundRom = romsByCrc[crc];
								if (foundRom) {
									if ((romsByCrc[crc].romNames.includes(filename)) == false) {
										romsByCrc[crc].romNames.push(romNameArray);
									}
								} else {
									const romInfo = {
										romNames: romNameArray,
										size: size,
										sha1: sha1
									}
									romsByCrc[crc] = romInfo;
								}
							}
						}
					}
				}
			}
			log(`${RomsFound} MAME ROMs parsed`);

			return romsByCrc;
		}

		async function getFileContent(url, file) {
		  try {
			const response = await fetch(url + file);
			if (!response.ok) {
			  throw new Error(`HTTP error! status: ${response.status}`);
			}
			const fileContent = await response.text();
			return fileContent;
		  } catch (error) {
			console.error("Error fetching ${file}", error);
			return null;
		  }
		}

		async function parseGamesxml(romsByCrc) {
			const SupermodelUrl = "https://raw.githubusercontent.com/trzy/Supermodel/refs/heads/master/Config/";
			const GamesXml = "Games.xml";
			log(`Fetching content from: ${SupermodelUrl + GamesXml}`);
			const content = await getFileContent(SupermodelUrl, GamesXml);
			if (!content) {
				alert(`Error fetching ${GamesXml}\nRefresh the page to try again`);
				return;
			} else {
				log(`Parsing ${GamesXml} and adding SHA-1 and size info to the matching CRCs\n`);
				const knownProblemCrcs = "e028d7ca 60aa9d76"; // mgtrkbad roms
				const lines = content.split(/\r?\n/);
				for (const line of lines) {
					if (line.includes(`<game name=`)) {
						if (datContent) {
							datContent += `\t</machine>\n`;
						}
						const gameMatch = line.match(/"([^"]*)"/);
						datContent += `\n\t<machine name="${gameMatch[1]}">\n`;
					}
					else if (line.includes(`<title>`)) {
						const titleMatch = line.match(/>([^]*)</);
						datContent += `\t\t<description>${titleMatch[1]} `;
					}
					else if (line.includes(`<version>`)) {
						const versionMatch = line.match(/>([^]*)</);
						datContent += `(${versionMatch[1]})</description>\n`;
					}
					else if (line.includes(`<year>`)) {
						const trimLine = line.trim();
						datContent += `\t\t${trimLine}\n\t\t<manufacturer>Sega</manufacturer>\n`;
					}
					else if (line.includes(`<region name=`)) {
						const trimLine = line.trim();
						const splitLine = trimLine.split('"');
						if (line.includes(`required="false"`)) {
							datContent += `\t\t<!--region name="${splitLine[1]}" required="false"-->\n`; // Keep reminding people
						}
						else {
							datContent += `\t\t<!--region name="${splitLine[1]}"-->\n`;
						}
					}
					else if (line.includes(`<file offset=`)) {
						const splitLine = line.split('"');
						const crcTrim = splitLine[5].replace("0x", "").toLocaleLowerCase();
						if (romsByCrc[crcTrim])
						{
							if ((romsByCrc[crcTrim].romNames.includes(splitLine[3].toLocaleLowerCase())) == false) {
								console.log(`\nMismatch in crc ${crcTrim}\nSupermodel name: ${splitLine[3]}\nMAME driver name(s): ${romsByCrc[crcTrim].romNames.join(", ")}`);
							}

							datContent += `\t\t<rom name="${splitLine[3]}" size="${romsByCrc[crcTrim].size}" crc="${crcTrim}" sha1="${romsByCrc[crcTrim].sha1}"/>\n`;
						}
						else {
							if (knownProblemCrcs.includes(crcTrim) == false) {
								let notFound = `\t\t<rom name="${splitLine[3]}" crc="${crcTrim}"/> <!-- ${`#`.repeat(16)} NOT FOUND IN MAME ${`#`.repeat(16)} -->\n`;
								datContent += notFound;
								const lineChar = `*`;
								log(`${lineChar.repeat(52)} WARNING ${lineChar.repeat(52)}\n\nSupermodel is using a ROM not found in MAME, SHA-1 and size info will have to be added to the dat file manually.\n\n${notFound.trim()}\n\n${lineChar.repeat(113)}\n`);
							}
						}
					}
				}
			}
		}

		function generateOutput() {
			toggleHiddenElement(`dlbutton`);

			// Old bad dumps of Magical Truck are no longer found in mame.
			// Do a simple string replace to remove it.
			let mgtrkbadFind =
			`\n` +
			`\t<machine name="mgtrkbad">\n` +
			`\t\t<description>Magical Truck Adventure (Japan)</description>\n` +
			`\t\t<year>1998</year>\n` +
			`\t\t<manufacturer>Sega</manufacturer>\n` +
			`\t\t<!--region name="crom"-->\n` +
			`\t</machine>\n`;

			const date = new Date();
			const month = (`0` + `${date.getMonth() + 1}`).slice(-2);
			const day = (`0` + `${date.getDate()}`).slice(-2);
			let header =
			`<?xml version="1.0" encoding="UTF-8"?>\n` +
			`<datafile>\n` +
			`\t<header>\n` +
			`\t\t<name>Supermodel</name>\n` +
			`\t\t<description>Sega Model 3 Emulator</description>\n` +
			`\t\t<category>Arcade</category>\n` +
			`\t\t<date>${date.getFullYear()}-${month}-${day}</date>\n` +
			`\t\t<author>Supermodel dat maker.html</author>\n` +
			`\t\t<url>https://github.com/ToBul/Supermodel-dat-maker.html</url>\n` +
			`\t\t<comment>Matches Supermodel's Games.xml with mgtrkbad removed</comment>\n` +
			`\t</header>\n`;

			let footer =
			`\t</machine>\n` +
			`</datafile>`;

			let datOutput = header + datContent.replace(mgtrkbadFind, "") + footer;

			download(datOutput);

			const info =
			`mgtrkbad in Games.xml has been omitted from the dat as it does not exist in MAME.\n` +
			`mgtrkbad is not a separate game, it's just the old corrupt ROMs that used to be in magtruck.\n\n` +

			`To fully build the Supermodel ROM set you will need,\n` +
			`model3 ROM set (Mame 0.263 onwards)\n` +
			`stcc (from model2)\n` +
			`segabill\n\n` +

			`Although the dat produced will build ROMS to Supermodel's requirements with the correct\n` +
			`parent and child splits, you may still get drive board problems in lemans24.\n\n` +

			`lemans24 has 2 force feed back drive boards listed in the Games.xml.\n` +
			`epr-18261.ic9 is from stcc.\n` +
			`epr-19338a.bin is from scud.\n\n` +

			`Supermodel does not yet emulate the stcc ROM as the commands from it are not understood but\n` +
			`the scud ROM can be used in it's place. Users need to edit their Games.xml to select which\n` +
			`drive board is used.\n\n` +

			`Note that drive board emulation is not perfect!\n\n` +

			`BTW:\n` +
			`Changes or additions to the Model 3 ROM set will be increasingly rare.\n` +
			`Most updates to MAME and Supermodel do not touch the ROM set.\n` +
			`It should not be necessary to update your ROMs as often as some might think.`;

			document.getElementById("output").textContent = info;
		}

		function download(datOutput) {
			//creating an invisible element
			let element = document.createElement('a');

			element.setAttribute('href',
				'data:xml;charset=utf-8, '
				+ encodeURIComponent(datOutput));

			element.setAttribute('download', "Supermodel.dat");
			document.body.appendChild(element);
			element.click();

			document.body.removeChild(element);
		}

		buildDat();
	</script>
</body>
</html>
